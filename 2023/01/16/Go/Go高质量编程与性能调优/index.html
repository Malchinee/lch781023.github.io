

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/touxiang.png">
  <link rel="icon" href="/img/touxiang.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="John Doe">
  <meta name="keywords" content="">
  
    <meta name="description" content="高质量编程注释注释的作用：  代码作用：适合注释代码作用 代码如何做：适合注释实现过程 代码实现的原因：适合解释代码的外部因素，提供额外上下文 代码什么时候会出错：适合解释代码的限制条件  公共符号始终要注释  包中表明的每个公共的符号、变量、常量、函数以及结构体都需要添加注释 任何既不明显也不见简短的公共功能必须注释 无论长度或复杂程度如何，库里的任何函数都必须注释  实现接口的方法可以不用注释">
<meta property="og:type" content="article">
<meta property="og:title" content="Go高质量编程与性能调优">
<meta property="og:url" content="https://www.example.com/2023/01/16/Go/Go%E9%AB%98%E8%B4%A8%E9%87%8F%E7%BC%96%E7%A8%8B%E4%B8%8E%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="高质量编程注释注释的作用：  代码作用：适合注释代码作用 代码如何做：适合注释实现过程 代码实现的原因：适合解释代码的外部因素，提供额外上下文 代码什么时候会出错：适合解释代码的限制条件  公共符号始终要注释  包中表明的每个公共的符号、变量、常量、函数以及结构体都需要添加注释 任何既不明显也不见简短的公共功能必须注释 无论长度或复杂程度如何，库里的任何函数都必须注释  实现接口的方法可以不用注释">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://www.example.com/2023/01/16/Go/Go%E9%AB%98%E8%B4%A8%E9%87%8F%E7%BC%96%E7%A8%8B%E4%B8%8E%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/image-20230116203501846.png">
<meta property="og:image" content="https://www.example.com/2023/01/16/Go/Go%E9%AB%98%E8%B4%A8%E9%87%8F%E7%BC%96%E7%A8%8B%E4%B8%8E%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/image-20230116204110369.png">
<meta property="og:image" content="https://www.example.com/2023/01/16/Go/Go%E9%AB%98%E8%B4%A8%E9%87%8F%E7%BC%96%E7%A8%8B%E4%B8%8E%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/image-20230116204611027.png">
<meta property="og:image" content="https://www.example.com/2023/01/16/Go/Go%E9%AB%98%E8%B4%A8%E9%87%8F%E7%BC%96%E7%A8%8B%E4%B8%8E%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/image-20230116204658813.png">
<meta property="og:image" content="https://www.example.com/2023/01/16/Go/Go%E9%AB%98%E8%B4%A8%E9%87%8F%E7%BC%96%E7%A8%8B%E4%B8%8E%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/image-20230116205241493.png">
<meta property="og:image" content="https://www.example.com/2023/01/16/Go/Go%E9%AB%98%E8%B4%A8%E9%87%8F%E7%BC%96%E7%A8%8B%E4%B8%8E%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/image-20230117101704895.png">
<meta property="og:image" content="https://www.example.com/2023/01/16/Go/Go%E9%AB%98%E8%B4%A8%E9%87%8F%E7%BC%96%E7%A8%8B%E4%B8%8E%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/image-20230117101755755.png">
<meta property="og:image" content="https://www.example.com/2023/01/16/Go/Go%E9%AB%98%E8%B4%A8%E9%87%8F%E7%BC%96%E7%A8%8B%E4%B8%8E%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/image-20230116212020437.png">
<meta property="og:image" content="https://www.example.com/2023/01/16/Go/Go%E9%AB%98%E8%B4%A8%E9%87%8F%E7%BC%96%E7%A8%8B%E4%B8%8E%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/image-20230116212108037.png">
<meta property="og:image" content="https://www.example.com/2023/01/16/Go/Go%E9%AB%98%E8%B4%A8%E9%87%8F%E7%BC%96%E7%A8%8B%E4%B8%8E%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/image-20230117102617066.png">
<meta property="og:image" content="https://www.example.com/2023/01/16/Go/Go%E9%AB%98%E8%B4%A8%E9%87%8F%E7%BC%96%E7%A8%8B%E4%B8%8E%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/image-20230117113842851.png">
<meta property="og:image" content="https://www.example.com/2023/01/16/Go/Go%E9%AB%98%E8%B4%A8%E9%87%8F%E7%BC%96%E7%A8%8B%E4%B8%8E%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/image-20230117114617936.png">
<meta property="og:image" content="https://www.example.com/2023/01/16/Go/Go%E9%AB%98%E8%B4%A8%E9%87%8F%E7%BC%96%E7%A8%8B%E4%B8%8E%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/image-20230117114822181.png">
<meta property="og:image" content="https://www.example.com/2023/01/16/Go/Go%E9%AB%98%E8%B4%A8%E9%87%8F%E7%BC%96%E7%A8%8B%E4%B8%8E%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/image-20230117114802769.png">
<meta property="og:image" content="https://www.example.com/2023/01/16/Go/Go%E9%AB%98%E8%B4%A8%E9%87%8F%E7%BC%96%E7%A8%8B%E4%B8%8E%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/image-20230117114906706.png">
<meta property="og:image" content="https://www.example.com/2023/01/16/Go/Go%E9%AB%98%E8%B4%A8%E9%87%8F%E7%BC%96%E7%A8%8B%E4%B8%8E%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/image-20230117115642954.png">
<meta property="og:image" content="https://www.example.com/2023/01/16/Go/Go%E9%AB%98%E8%B4%A8%E9%87%8F%E7%BC%96%E7%A8%8B%E4%B8%8E%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/image-20230117120124833.png">
<meta property="og:image" content="https://www.example.com/2023/01/16/Go/Go%E9%AB%98%E8%B4%A8%E9%87%8F%E7%BC%96%E7%A8%8B%E4%B8%8E%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/image-20230117121118392.png">
<meta property="og:image" content="https://www.example.com/2023/01/16/Go/Go%E9%AB%98%E8%B4%A8%E9%87%8F%E7%BC%96%E7%A8%8B%E4%B8%8E%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/image-20230117121202524.png">
<meta property="og:image" content="https://www.example.com/2023/01/16/Go/Go%E9%AB%98%E8%B4%A8%E9%87%8F%E7%BC%96%E7%A8%8B%E4%B8%8E%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/image-20230117125955642.png">
<meta property="og:image" content="https://www.example.com/2023/01/16/Go/Go%E9%AB%98%E8%B4%A8%E9%87%8F%E7%BC%96%E7%A8%8B%E4%B8%8E%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/image-20230117131542015.png">
<meta property="og:image" content="https://www.example.com/2023/01/16/Go/Go%E9%AB%98%E8%B4%A8%E9%87%8F%E7%BC%96%E7%A8%8B%E4%B8%8E%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/image-20230117131915331.png">
<meta property="og:image" content="https://www.example.com/2023/01/16/Go/Go%E9%AB%98%E8%B4%A8%E9%87%8F%E7%BC%96%E7%A8%8B%E4%B8%8E%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/image-20230117132240316.png">
<meta property="article:published_time" content="2023-01-16T10:51:27.000Z">
<meta property="article:modified_time" content="2023-01-17T06:02:37.385Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://www.example.com/2023/01/16/Go/Go%E9%AB%98%E8%B4%A8%E9%87%8F%E7%BC%96%E7%A8%8B%E4%B8%8E%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/image-20230116203501846.png">
  
  
  <title>Go高质量编程与性能调优 - Hexo</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4/github-markdown.min.css" />
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hint.css@2/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.css" />
  


<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"www.example.com","root":"/","version":"1.8.14","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 6.0.0"></head>

<!--动态线条背景-->
<script type="text/javascript"
color="220,220,220" opacity='0.7' zIndex="-2" count="200" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js">
</script>
<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>这里有即用配件</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/img/fengmian.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="Go高质量编程与性能调优">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2023-01-16 18:51" pubdate>
        2023年1月16日 晚上
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      5k 字
    </span>
  

  
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      42 分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">Go高质量编程与性能调优</h1>
            
            <div class="markdown-body">
              <h1 id="高质量编程"><a href="#高质量编程" class="headerlink" title="高质量编程"></a>高质量编程</h1><h2 id="注释"><a href="#注释" class="headerlink" title="注释"></a>注释</h2><p>注释的作用：</p>
<ul>
<li>代码作用：适合注释代码作用</li>
<li>代码如何做：适合注释实现过程</li>
<li>代码实现的原因：适合解释代码的外部因素，提供额外上下文</li>
<li>代码什么时候会出错：适合解释代码的限制条件</li>
</ul>
<p>公共符号始终要注释</p>
<ul>
<li>包中表明的每个公共的<strong>符号、变量、常量、函数</strong>以及结构体都需要添加注释</li>
<li>任何既不明显也不见简短的<strong>公共功能</strong>必须注释</li>
<li>无论长度或复杂程度如何，<strong>库里的任何函数</strong>都必须注释</li>
</ul>
<p>实现接口的方法可以不用注释</p>
<h2 id="代码格式"><a href="#代码格式" class="headerlink" title="代码格式"></a>代码格式</h2><p>推荐使用gofmt自动格式化代码</p>
<h2 id="命名规范"><a href="#命名规范" class="headerlink" title="命名规范"></a>命名规范</h2><p><strong>变量Variable：</strong></p>
<ul>
<li><p>简洁胜于冗长</p>
<figure class="highlight go"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">for</span> index := <span class="hljs-number">0</span>; i &lt; n ; i ++ &#123;&#125;<br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; n; i ++ &#123;&#125;<br></code></pre></td></tr></table></figure>
<p>i和index作用域相同，用i不用index</p>
</li>
<li><p>缩略词全大写，但当其位于变量开头且不需要导出时，使用全小写</p>
</li>
<li><p>变量距离其被使用的地方越远，则需要携带越多的上下文信息</p>
<ul>
<li>全局变量在其名字中需要更多的上下文信息，使得在不同地方可以轻易辨认出其含义</li>
</ul>
</li>
</ul>
<p><strong>函数function</strong></p>
<ul>
<li>函数名不携带包的上下文信息，因为包名和函数名总是成对出现的</li>
<li>函数名尽量简短</li>
<li>当名为foo的包某个函数返回类型Foo时，可以省略类型信息而不导致歧义</li>
<li>当名为foo的包某个函数返回类型T时，可以在函数名中加入类型信息</li>
</ul>
<p><strong>包package</strong></p>
<ul>
<li>只有小写字母组成。不包括大写字母和下划线等字符</li>
<li>简短并包含一定的上下文信息。如schema、task等</li>
<li>不要与标准库名相同</li>
<li>不适用常用变量名为包名，比如使用bufio而不是buf</li>
<li>使用单数而不是负数，如使用encoding而不是encodings</li>
<li>谨慎的使用缩写，使用fmt在不破坏上下文的情况下比format更简短</li>
</ul>
<h2 id="控制流程"><a href="#控制流程" class="headerlink" title="控制流程"></a>控制流程</h2><p>避免嵌套，保持正常流程运行</p>
<ul>
<li>如果两个分支都包含return语句，则可以去掉冗余的else</li>
</ul>
<p>尽量保持正常代码路径为最小缩进</p>
<h2 id="错误和异常处理"><a href="#错误和异常处理" class="headerlink" title="错误和异常处理"></a>错误和异常处理</h2><p>简单错误：</p>
<ul>
<li>优先使用errors.New来创建匿名变量来直接1表示简单错误</li>
<li>如果有格式化的需求，使用fmt.Errorf</li>
</ul>
<p>错误的Wrap和Unwrap</p>
<ul>
<li>错误的Wrap实际上是提供了一个error嵌套另一个error的能力，从而生成了一个error的跟踪链</li>
<li>在fmt.Errorf中使用%w关键字来将一个错误关联至错误链中</li>
</ul>
<p>错误判定：</p>
<ul>
<li><p>errors.Is,判断一个错误是否为特定错误</p>
</li>
<li><p>不同于使用==，该方法可以判定错误链上的所有错误是否含有特定的错误</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go">errors.Is(err, fs.ErrNotExit)<br></code></pre></td></tr></table></figure>
</li>
<li><p>在错误链上获取特定种类的错误，使用errors.As</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go">errors.As(err, &amp;pathError)<br></code></pre></td></tr></table></figure>
</li>
<li><p>panic，不建议在业务代码使用，但是当程序启动阶段发生不可逆的错误时，可以在init或main函数中使用panic</p>
</li>
<li><p>recover只能在被defer的函数中使用，嵌套无法生效，只在当前goroutine生效。如果需要更多的上下文信息，可以在recover后在log中记录当前的调用栈.</p>
<p>defer总是后进先出</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(t *treeFs)</span></span> Open(name <span class="hljs-type">string</span>) (f fs.File, err <span class="hljs-type">error</span>) &#123;<br>	<span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>		<span class="hljs-keyword">if</span> e := <span class="hljs-built_in">recover</span>(); e != <span class="hljs-literal">nil</span> &#123;<br>			f = <span class="hljs-literal">nil</span><br>			err = fmt.Errorf(<span class="hljs-string">&quot;gitfs panic: %v\n%s&quot;</span>, e, debug.Stack())<br>		&#125;<br>    &#125;()<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
</ul>
<h1 id="性能优化"><a href="#性能优化" class="headerlink" title="性能优化"></a>性能优化</h1><p>Go语言提供了支持基准性能测试工具<strong>benchmark</strong></p>
<h2 id="Slice预分配内存"><a href="#Slice预分配内存" class="headerlink" title="Slice预分配内存"></a>Slice预分配内存</h2><p>尽可能在使用mark()初始化切片时提供容量信息，与vector类似</p>
<p>如果函数返回切片的一部分，不释放大切片将会造成大内存未释放</p>
<h2 id="map预分配内存"><a href="#map预分配内存" class="headerlink" title="map预分配内存"></a>map预分配内存</h2><p>不断向map中添加元素的操作会触发map的扩容</p>
<p>提前分配好空间可以减少内存拷贝和Rehash的消耗</p>
<h2 id="字符串处理"><a href="#字符串处理" class="headerlink" title="字符串处理"></a>字符串处理</h2><p>使用strings.Builder处理字符串</p>
<h2 id="空结构体"><a href="#空结构体" class="headerlink" title="空结构体"></a>空结构体</h2><p>使用空结构体节省内存</p>
<p>空结构体实例不占据任何内存空间，可作为各种场景下的占位符使用</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs go">m := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">int</span>]<span class="hljs-keyword">struct</span>&#123;&#125;)	<span class="hljs-comment">// 节省空间</span><br>m := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">int</span>]<span class="hljs-type">bool</span>)		<br></code></pre></td></tr></table></figure>
<p>实现set，也可以考虑用map来替代</p>
<h2 id="多线程"><a href="#多线程" class="headerlink" title="多线程"></a>多线程</h2><p>使用atomic包，可以维护一个原子的变量（多用于多线程对计数器的加减）</p>
<p>锁的实现是通过操作系统实现的，属于系统调用，效率比atomic包通过硬件实现的效率低</p>
<h1 id="性能调优工具pprof"><a href="#性能调优工具pprof" class="headerlink" title="性能调优工具pprof"></a>性能调优工具pprof</h1><p>原则：</p>
<ul>
<li>依靠数据而不是猜测</li>
<li>要定位最大瓶颈而不是细枝末节</li>
<li>不要过早、过度优化</li>
</ul>
<h2 id="Web浏览器查看"><a href="#Web浏览器查看" class="headerlink" title="Web浏览器查看"></a>Web浏览器查看</h2><img src="/2023/01/16/Go/Go%E9%AB%98%E8%B4%A8%E9%87%8F%E7%BC%96%E7%A8%8B%E4%B8%8E%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/image-20230116203501846.png" srcset="/img/loading.gif" lazyload class title="image-20230116203501846">
<p><a target="_blank" rel="noopener" href="https://github.com/wolfogre/go-pprof-practice">拉取代码</a>运行后，可以在浏览器打开xxxx:6060/debuf/pprof    （我是vscode + remote），如果是本机的话localhost就行</p>
<img src="/2023/01/16/Go/Go%E9%AB%98%E8%B4%A8%E9%87%8F%E7%BC%96%E7%A8%8B%E4%B8%8E%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/image-20230116204110369.png" srcset="/img/loading.gif" lazyload class title="image-20230116204110369">
<p>运行程序后，在终端查看</p>
<h2 id="命令行工具"><a href="#命令行工具" class="headerlink" title="命令行工具"></a>命令行工具</h2><p>输入查看CPU运行情况</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">go tool pprof &quot;http://localhost:6060/debug/pprof/profile?seconds=10&quot;<br></code></pre></td></tr></table></figure>
<img src="/2023/01/16/Go/Go%E9%AB%98%E8%B4%A8%E9%87%8F%E7%BC%96%E7%A8%8B%E4%B8%8E%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/image-20230116204611027.png" srcset="/img/loading.gif" lazyload class title="image-20230116204611027">
<p>结束之后，输入<strong>top</strong>命令展示：</p>
<img src="/2023/01/16/Go/Go%E9%AB%98%E8%B4%A8%E9%87%8F%E7%BC%96%E7%A8%8B%E4%B8%8E%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/image-20230116204658813.png" srcset="/img/loading.gif" lazyload class title="image-20230116204658813">
<ul>
<li>flat：当前函数本身的执行耗时</li>
<li>flat%：flat占CPU总时间的比例</li>
<li>sum%：上面每一行的flat%总和</li>
<li>cum：当前函数本身加上其调用函数的总耗时</li>
<li>cum%：cum占CPU总时间的比例</li>
</ul>
<p>Flat == Cum，函数没有调用其他函数</p>
<p>Flat == 0，函数中只有其他函数调用</p>
<p><strong>list</strong>命令根据正则表达式查找代码行</p>
<img src="/2023/01/16/Go/Go%E9%AB%98%E8%B4%A8%E9%87%8F%E7%BC%96%E7%A8%8B%E4%B8%8E%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/image-20230116205241493.png" srcset="/img/loading.gif" lazyload class title="image-20230116205241493">
<p><strong>web</strong>命令调用关系可视化</p>
<h2 id="可视化工具"><a href="#可视化工具" class="headerlink" title="可视化工具"></a>可视化工具</h2><p>在使用了上述命令行工具后，在$HOME/路径下会生成pprof文件夹，里面存放着信息：</p>
<img src="/2023/01/16/Go/Go%E9%AB%98%E8%B4%A8%E9%87%8F%E7%BC%96%E7%A8%8B%E4%B8%8E%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/image-20230117101704895.png" srcset="/img/loading.gif" lazyload class title="image-20230117101704895">
<img src="/2023/01/16/Go/Go%E9%AB%98%E8%B4%A8%E9%87%8F%E7%BC%96%E7%A8%8B%E4%B8%8E%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/image-20230117101755755.png" srcset="/img/loading.gif" lazyload class title="image-20230117101755755">
<p>然后进入这个文件夹，在终端输入：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">go tool pprof -http=:8080 文件名<br></code></pre></td></tr></table></figure>
<p>就会在浏览器生成可视化工具</p>
<p><strong>top：</strong></p>
<img src="/2023/01/16/Go/Go%E9%AB%98%E8%B4%A8%E9%87%8F%E7%BC%96%E7%A8%8B%E4%B8%8E%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/image-20230116212020437.png" srcset="/img/loading.gif" lazyload class title="image-20230116212020437">
<p><strong>Source：</strong></p>
<img src="/2023/01/16/Go/Go%E9%AB%98%E8%B4%A8%E9%87%8F%E7%BC%96%E7%A8%8B%E4%B8%8E%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/image-20230116212108037.png" srcset="/img/loading.gif" lazyload class title="image-20230116212108037">
<h2 id="火焰图"><a href="#火焰图" class="headerlink" title="火焰图"></a>火焰图</h2><p>需要安装PProf原生工具</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">go install github.com/google/pprof@latest<br></code></pre></td></tr></table></figure>
<p>然后像上面一样，在$HOME/用户名/pprof目录下执行</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">pprof -http=:8080 文件名<br></code></pre></td></tr></table></figure>
<p>会在浏览器打开</p>
<img src="/2023/01/16/Go/Go%E9%AB%98%E8%B4%A8%E9%87%8F%E7%BC%96%E7%A8%8B%E4%B8%8E%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/image-20230117102617066.png" srcset="/img/loading.gif" lazyload class title="image-20230117102617066">
<h1 id="性能调优案例"><a href="#性能调优案例" class="headerlink" title="性能调优案例"></a>性能调优案例</h1><p>可能需要优化的服务：</p>
<ul>
<li>业务服务优化</li>
<li>基础库优化</li>
<li>Go语言优化</li>
</ul>
<h2 id="业务服务优化"><a href="#业务服务优化" class="headerlink" title="业务服务优化"></a>业务服务优化</h2><p><strong>服务</strong>：能单独部署，承载一定功能的程序</p>
<p><strong>依赖</strong>：Service A的功能实现依赖Service B的响应结果，称为Service A依赖Service B</p>
<p><strong>调用链路</strong>：能支持一个接口请求的相关服务的集合及其相互之间的依赖关系</p>
<p><strong>基础库</strong>：公共的工具包、中间件</p>
<p>流程：</p>
<ol>
<li><p><strong>建议服务性能评估手段</strong></p>
<ul>
<li>服务性能评估：单独benchmark无法满腹复杂的业务逻辑、不同负载情况下性能表现差异</li>
<li>请求流量构造：不同请求参数覆盖逻辑不同、线上真实流量情况</li>
<li>压测范围：单机、集群</li>
<li>性能数据采集：单机、集群</li>
</ul>
</li>
<li><p><strong>分析业务数据，定位性能瓶颈</strong></p>
<ul>
<li>使用库不规范</li>
<li>高并发场景优化不足</li>
</ul>
</li>
<li><p><strong>终点优化项改造</strong></p>
<ul>
<li>正确性是基础</li>
<li>响应数据diff：线上请求数据录制回放、新旧接口逻辑数据diff</li>
</ul>
</li>
<li><p><strong>效果优化验证</strong></p>
<ul>
<li>重复压测验证</li>
<li>上线评估优化效果</li>
</ul>
</li>
</ol>
<h2 id="基础库优化"><a href="#基础库优化" class="headerlink" title="基础库优化"></a>基础库优化</h2><ol>
<li><strong>分析基础库核心逻辑和性能瓶颈</strong><ul>
<li>设计完善改造方案</li>
<li>数据按需获取</li>
<li>数据序列化协议优化</li>
</ul>
</li>
<li><strong>内部压测验证</strong></li>
<li><strong>推广业务服务落地验证</strong></li>
</ol>
<h2 id="Go语言优化"><a href="#Go语言优化" class="headerlink" title="Go语言优化"></a>Go语言优化</h2><p>编译器&amp;运行时优化</p>
<ol>
<li>优化内存分配策略</li>
<li>优化代码编译流程，生成更高效的程序</li>
<li>内部压测验证</li>
<li>推广业务服务落地验证</li>
</ol>
<p>优点：</p>
<ul>
<li>接入简单</li>
<li>通用性强</li>
</ul>
<h1 id="Go内存管理"><a href="#Go内存管理" class="headerlink" title="Go内存管理"></a>Go内存管理</h1><h2 id="自动内存管理"><a href="#自动内存管理" class="headerlink" title="自动内存管理"></a>自动内存管理</h2><p>相关概念：</p>
<p><strong>Mutator</strong>：业务线程，分配新对象，修改对象指向关系</p>
<p><strong>Collector</strong>：GC线程，找到存活对象，回收死亡对象的内存空间</p>
<p><strong>Serial GC</strong>：只有一个collector</p>
<p><strong>Paraller GC</strong>：支持多个collectors同时回收的GC算法</p>
<p><strong>Concurrent GC</strong>：mutator(s)和collector(s)可以同时执行，<strong>必须要感知对象指向关系的改变</strong></p>
<img src="/2023/01/16/Go/Go%E9%AB%98%E8%B4%A8%E9%87%8F%E7%BC%96%E7%A8%8B%E4%B8%8E%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/image-20230117113842851.png" srcset="/img/loading.gif" lazyload class title="image-20230117113842851">
<p>评价GC算法：</p>
<ul>
<li>安全性（基本要求），如上图的b对象必须标记</li>
<li><p>吞吐率（花在GC的时间）：1- GC时间/程序执行总时间</p>
</li>
<li><p>暂停时间（业务是否感知）</p>
</li>
<li><p>内存开销（GC元数据开销）</p>
</li>
</ul>
<h3 id="追踪垃圾回收"><a href="#追踪垃圾回收" class="headerlink" title="追踪垃圾回收"></a>追踪垃圾回收</h3><p>对象被回收的条件：指针指向关系不可达的对象</p>
<img src="/2023/01/16/Go/Go%E9%AB%98%E8%B4%A8%E9%87%8F%E7%BC%96%E7%A8%8B%E4%B8%8E%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/image-20230117114617936.png" srcset="/img/loading.gif" lazyload class title="image-20230117114617936">
<ul>
<li><p>标记根对象：静态变量、全局变量、常量、线程栈等</p>
</li>
<li><p>标记：找到可达对象。求指针指向关系的传递闭包：从根对象触发，找到所有可达对象</p>
</li>
<li><p>清理：所有不可达对象。三个策略：</p>
<ul>
<li><p>将所有存活对象复制到另外的内存空间copying collection</p>
</li>
<li><img src="/2023/01/16/Go/Go%E9%AB%98%E8%B4%A8%E9%87%8F%E7%BC%96%E7%A8%8B%E4%B8%8E%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/image-20230117114822181.png" srcset="/img/loading.gif" lazyload class title="image-20230117114822181">
</li>
<li><p>将死亡对象的内存标记为”可分配“mark-sweep collection</p>
<img src="/2023/01/16/Go/Go%E9%AB%98%E8%B4%A8%E9%87%8F%E7%BC%96%E7%A8%8B%E4%B8%8E%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/image-20230117114802769.png" srcset="/img/loading.gif" lazyload class title="image-20230117114802769">
</li>
<li><p>移动并整理存活对象mark-compact collection</p>
<img src="/2023/01/16/Go/Go%E9%AB%98%E8%B4%A8%E9%87%8F%E7%BC%96%E7%A8%8B%E4%B8%8E%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/image-20230117114906706.png" srcset="/img/loading.gif" lazyload class title="image-20230117114906706">
</li>
</ul>
</li>
</ul>
<h3 id="分代GC"><a href="#分代GC" class="headerlink" title="分代GC"></a>分代GC</h3><p>分代假说：很多对象在分配出来后很快就不再使用了</p>
<p>每个对象都有年龄：经历过GC的次数</p>
<p><strong>目的：对年轻和老年的对象，制定不同的GC策略，降低整体内存管理的开销</strong></p>
<p>不同的年龄对象处于heap的不同区域</p>
<ul>
<li>年轻代：常规的对象分配，由于存活对象很少，可以采用copying collection</li>
<li>老年代：对象趋于一直活着，反复复制开销很大，可以采用mark-sweep collection</li>
</ul>
<h3 id="引用计数"><a href="#引用计数" class="headerlink" title="引用计数"></a>引用计数</h3><p>每个对象都有一个与之关联的引用数目</p>
<p>对象存活的条件：当且仅当引用数大于0</p>
<img src="/2023/01/16/Go/Go%E9%AB%98%E8%B4%A8%E9%87%8F%E7%BC%96%E7%A8%8B%E4%B8%8E%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/image-20230117115642954.png" srcset="/img/loading.gif" lazyload class title="image-20230117115642954">
<p>优点：</p>
<ul>
<li>内存管理的操作被平摊到程序执行过程中</li>
<li>内存管理不需要了解runtime的实现细节</li>
</ul>
<p>缺点：</p>
<ul>
<li><p>维护开销大，通过<strong>原子操作</strong>才能保证对引用计数操作的原子性和可见性</p>
</li>
<li><p>无法回收环形数据结构——weak reference</p>
<img src="/2023/01/16/Go/Go%E9%AB%98%E8%B4%A8%E9%87%8F%E7%BC%96%E7%A8%8B%E4%B8%8E%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/image-20230117120124833.png" srcset="/img/loading.gif" lazyload class title="image-20230117120124833">
</li>
<li><p>内存开销：每个对象都引入的额外内存空间存储引用数目</p>
</li>
<li>回收内存时，依然可能引发暂停</li>
</ul>
<h2 id="Go内存分配"><a href="#Go内存分配" class="headerlink" title="Go内存分配"></a>Go内存分配</h2><h3 id="分块"><a href="#分块" class="headerlink" title="分块"></a>分块</h3><p>目标：为对象在heap上分配内存</p>
<ul>
<li>调用系统调用mmap() 向OS申请一大块内存，例如4MB</li>
<li>先将内存划分为大块，例如8KB，乘坐msapn</li>
<li>再将大块分为特定大小的小块，用于对象分配</li>
<li>noscan mspan：分配不含指针的独享</li>
<li>scan msapn：分配包含指针的对象</li>
</ul>
<p>对象分配：根据对象的大小，选择最合适的块返回</p>
<img src="/2023/01/16/Go/Go%E9%AB%98%E8%B4%A8%E9%87%8F%E7%BC%96%E7%A8%8B%E4%B8%8E%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/image-20230117121118392.png" srcset="/img/loading.gif" lazyload class title="image-20230117121118392">
<h3 id="缓存"><a href="#缓存" class="headerlink" title="缓存"></a>缓存</h3><p>借鉴TCMalloc：thread caching</p>
<img src="/2023/01/16/Go/Go%E9%AB%98%E8%B4%A8%E9%87%8F%E7%BC%96%E7%A8%8B%E4%B8%8E%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/image-20230117121202524.png" srcset="/img/loading.gif" lazyload class title="image-20230117121202524">
<p>每个p包含一个mcache用于快速分配，用于为绑定于p上的g分配对象</p>
<p>mcache管理一组mspan</p>
<p>当mcache中的mspan分配完毕，向mcentral申请带有未分配块的span</p>
<p>当mspan中没有分配的对象时，mspan会缓存在mcentral中，而不是立刻释放并归还给OS</p>
<h3 id="优化"><a href="#优化" class="headerlink" title="优化"></a>优化</h3><p><strong>现状：</strong></p>
<p>对象分配时非常高频的操作：<strong>每秒分配GB级别</strong></p>
<p>小对象占比高</p>
<p>Go内存分配比较耗时：</p>
<ul>
<li>分配路径长：g-&gt; m -&gt; p -&gt; mcache -&gt; mspan -&gt; memory block -&gt;return pointer</li>
<li>pprof：对象分配的函数是最频繁调用的函数之一</li>
</ul>
<p><strong>优化方案：Bananced GC</strong></p>
<p>每个g都绑定一大块内存(1KB)，称作goroutine allocation buffer(GAB)</p>
<p>每个GAB用于noscan类型的小对象分配( &lt; 128 B)</p>
<p>使用三个指针维护GAB: base, end, top</p>
<img src="/2023/01/16/Go/Go%E9%AB%98%E8%B4%A8%E9%87%8F%E7%BC%96%E7%A8%8B%E4%B8%8E%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/image-20230117125955642.png" srcset="/img/loading.gif" lazyload class title="image-20230117125955642">
<p>Bump pointer（指针碰撞）风格对象分配</p>
<ul>
<li>无须和其他分配请求互斥</li>
<li>分配动作简单高效</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">if</span> top + size &lt;= end &#123;<br>	addr := top<br>	top += size<br>	<span class="hljs-keyword">return</span> addr<br>&#125;<br></code></pre></td></tr></table></figure>
<p>一个GAB对于Go内存管理来说是一个大对象，本质上是将多个小对象的分配合并成一次大对象的分配，但是GAB的对象分配方式会导致内存被延迟释放。</p>
<p>解决办法：移动GAB中的存活的对象，本质上用copying GC的算法管理小对象</p>
<img src="/2023/01/16/Go/Go%E9%AB%98%E8%B4%A8%E9%87%8F%E7%BC%96%E7%A8%8B%E4%B8%8E%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/image-20230117131542015.png" srcset="/img/loading.gif" lazyload class title="image-20230117131542015">
<h2 id="编译器和静态分析"><a href="#编译器和静态分析" class="headerlink" title="编译器和静态分析"></a>编译器和静态分析</h2><p>编译器：</p>
<img src="/2023/01/16/Go/Go%E9%AB%98%E8%B4%A8%E9%87%8F%E7%BC%96%E7%A8%8B%E4%B8%8E%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/image-20230117131915331.png" srcset="/img/loading.gif" lazyload class title="image-20230117131915331">
<p>静态分析：不执行程序代码，推导程序的行为，分析程序的性质</p>
<ul>
<li><p>控制流：程序执行的流程</p>
<img src="/2023/01/16/Go/Go%E9%AB%98%E8%B4%A8%E9%87%8F%E7%BC%96%E7%A8%8B%E4%B8%8E%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/image-20230117132240316.png" srcset="/img/loading.gif" lazyload class title="image-20230117132240316">
</li>
<li><p>数据流：数据在控制流上的传递</p>
</li>
</ul>
<p>通过分析控制流和数据流，可以知道更多关于程序的性质</p>
<p>过程内的分析：仅在函数内部进行分析</p>
<p>过程间分析：考虑函数调用时参数传递和返回值的数据流和控制流</p>
<h2 id="Go编译器优化"><a href="#Go编译器优化" class="headerlink" title="Go编译器优化"></a>Go编译器优化</h2><h3 id="函数内联"><a href="#函数内联" class="headerlink" title="函数内联"></a>函数内联</h3><p><strong>将被调用函数的函数体callee的副本替换到调用位置caller上</strong>，同时重写代码以反映参数的绑定</p>
<p>优点：</p>
<ul>
<li>消除函数调用开销，例如传递参数、保存寄存器等</li>
<li><strong>将过程间分析转化为过程内分析</strong>，帮助其他优化，如逃逸分析</li>
</ul>
<h3 id="逃逸分析"><a href="#逃逸分析" class="headerlink" title="逃逸分析"></a>逃逸分析</h3><p>分析代码中指针的动态作用域：指针在何处可以被访问</p>
<p>大致思路：</p>
<ul>
<li>从对像分配处出发，沿着控制流，观察对象的数据流</li>
<li>若发现指针p在当前作用域s：<ul>
<li>作为参数传递给其他函数</li>
<li>传递给全局变量</li>
<li>传递给其他的goroutine</li>
<li>传递给已逃逸的指针指向的对象</li>
</ul>
</li>
<li>则指针p指向的对象逃逸出s，反之则没有逃逸出s</li>
</ul>
<h3 id="Beast-Mode"><a href="#Beast-Mode" class="headerlink" title="Beast Mode"></a>Beast Mode</h3><p>Go函数内联受到的限制较多</p>
<ul>
<li>语言特性，interface，defer等限制了函数内联</li>
<li>内联策略十分保守</li>
</ul>
<p>调整函数内联的策略，使更多的函数被内联。函数内联拓展了函数边界，更多对象不逃逸</p>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/%E9%9D%92%E8%AE%AD%E8%90%A5/">青训营</a>
                    
                      <a class="hover-with-bg" href="/categories/%E9%9D%92%E8%AE%AD%E8%90%A5/Go%E8%AF%AD%E8%A8%80%E5%8E%9F%E7%90%86%E4%B8%8E%E5%AE%9E%E8%B7%B5/">Go语言原理与实践</a>
                    
                  </div>
                
                
              </div>
              
                <p class="note note-warning">
                  
                    本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2023/01/17/Go/DATABASE-SQL%E4%B8%8EGORM%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E8%B7%B5/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">DATABASE/SQL与GORM设计与实践</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2023/01/15/Go/Go%E5%B7%A5%E7%A8%8B%E8%BF%9B%E9%98%B6/">
                        <span class="hidden-mobile">Go工程进阶</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
              <!-- Comments -->
              <article class="comments" id="comments" lazyload>
                
                  
                
                
  <div id="valine"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#valine', function() {
      Fluid.utils.createScript('https://cdn.jsdelivr.net/npm/valine@1/dist/Valine.min.js', function() {
        var options = Object.assign(
          {"appId":"FVOHeWkJmFW4IL0Dyt3XhY5f-gzGzoHsz","appKey":"aguFoKPPLq6Qvk8DAkOgsdkz","path":"window.location.pathname","placeholder":null,"avatar":"retro","meta":["nick","mail","link"],"requiredFields":[],"pageSize":10,"lang":"zh-CN","highlight":true,"recordIP":true,"serverURLs":"https://fvohewkj.lc-cn-n1-shared.com","emojiCDN":null,"emojiMaps":null,"enableQQ":true},
          {
            el: "#valine",
            path: window.location.pathname
          }
        )
        new Valine(options);
        Fluid.utils.waitElementVisible('#valine .vcontent', () => {
          Fluid.plugins.initFancyBox('#valine .vcontent img:not(.vemoji)');
        })
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


              </article>
            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  

  

  
</footer>
<span id="timeDate">载入天数...</span><span id="times">载入时分秒...</span>
<script>
    var now = new Date(); 
    function createtime() { 
        var grt= new Date("08/10/2018 17:38:00");//在此处修改你的建站时间，格式：月/日/年 时:分:秒
        now.setTime(now.getTime()+250); 
        days = (now - grt ) / 1000 / 60 / 60 / 24; dnum = Math.floor(days); 
        hours = (now - grt ) / 1000 / 60 / 60 - (24 * dnum); hnum = Math.floor(hours); 
        if(String(hnum).length ==1 ){hnum = "0" + hnum;} minutes = (now - grt ) / 1000 /60 - (24 * 60 * dnum) - (60 * hnum); 
        mnum = Math.floor(minutes); if(String(mnum).length ==1 ){mnum = "0" + mnum;} 
        seconds = (now - grt ) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum); 
        snum = Math.round(seconds); if(String(snum).length ==1 ){snum = "0" + snum;} 
        document.getElementById("timeDate").innerHTML = "本站已安全运行 "+dnum+" 天 "; 
        document.getElementById("times").innerHTML = hnum + " 小时 " + mnum + " 分 " + snum + " 秒"; 
    } 
setInterval("createtime()",250);
</script>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  <script  src="/js/local-search.js" ></script>



  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  
    <script  src="https://cdn.jsdelivr.net/npm/tocbot@4/dist/tocbot.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4/anchor.min.js" ></script>
  
  
    <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js" ></script>
  






  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
        typing(title);
      
    })(window, document);
  </script>





  

  
    <!-- MathJax -->
    <script>
      MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']]
        },
        loader: {
          load: ['ui/lazy']
        },
        options: {
          renderActions: {
            findScript: [10, doc => {
              document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
                const display = !!node.type.match(/; *mode=display/);
                const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
                const text = document.createTextNode('');
                node.parentNode.replaceChild(text, node);
                math.start = { node: text, delim: '', n: 0 };
                math.end = { node: text, delim: '', n: 0 };
                doc.math.push(math);
              });
            }, '', false],
            insertedScript: [200, () => {
              document.querySelectorAll('mjx-container').forEach(node => {
                let target = node.parentNode;
                if (target.nodeName.toLowerCase() === 'li') {
                  target.parentNode.classList.add('has-jax');
                }
              });
            }, '', false]
          }
        }
      };
    </script>

    <script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js" ></script>

  











<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>


<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/z16.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":true},"react":{"opacity":0.8},"log":false});</script></body>
</html>
